<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}UTBA{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="icon" href="{{ url_for('static', filename='images/logo/logo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
</head>
<body data-theme="">
    <nav id="navbar">
        <div class="container">
            <a href="/">
                <img src="{{ url_for('static', filename='images/logo/logo.png') }}" alt="UTBA" class="logo">
            </a>
            <div id="nav_select_list">
                <ul>
                    <li><a class="nav-link" href="/"><i class="fa-solid fa-house"></i></a></li>
                </ul>
            </div>
            <div id="contorl_panel">
            </div>
        </div>
    </nav>
    <div id='base_container'>
        {% block content %}
        {% endblock %}
      </div>
      <small id="ping_ms">404</small>
      <script src="{{ url_for('static', filename='js/get_label_cn.js') }}"></script>
      <script src="{{ url_for('static', filename='js/show_alert.js') }}"></script>

<script>
let ms = 0;
let user_data = null;
let PushNotification = [];

document.addEventListener('DOMContentLoaded', async function () {
    await fetchUserData();
});

async function fetchUserData() {
    const navSelectUl = document.getElementById('nav_select_list');
    navSelectUl.innerHTML = '';

    // æ·»åŠ é¦–é¡µé“¾æ¥
    const homeLink = document.createElement('li');
    homeLink.innerHTML = '<a class="nav-link" href="/"><i class="fa-solid fa-house"></i></a>';
    navSelectUl.appendChild(homeLink);

    try {
        const startTime = performance.now();
        const response = await fetch('/user_control/get_user_data', {
            method: 'GET',
            credentials: 'include'
        });
        const endTime = performance.now();
        const ms = Math.round(endTime - startTime);

        if (!response.ok) throw new Error('ç½‘ç»œå“åº”ä¸æ˜¯OK');

        const user_data = await response.json();

        const { username, id: userId } = user_data;

        update_navbar(user_data, ms);
        if (typeof username === 'string' && username.trim() !== '') {
            // å·²ç™»å½•
            const loginTrueLink = document.createElement('li');
            loginTrueLink.innerHTML = '<a class="nav-link" href="/template/fahui_data"><i class="fas fa-file-invoice"></i></a>';
            navSelectUl.appendChild(loginTrueLink);
            
            const accountingLink = document.createElement('li');
            accountingLink.innerHTML = '<a class="nav-link" href="/template/accounting" title="åšè´¦"><i class="fas fa-book"></i></a>';
            navSelectUl.appendChild(accountingLink);

            const profileLink = document.createElement('li');
            profileLink.innerHTML = '<a class="nav-link" href="/template/profile"><i class="fas fa-user"></i></a>';
            navSelectUl.appendChild(profileLink);

            // ğŸ”¹ æ–°å¢ï¼šç”¨æˆ·ç®¡ç†å…¥å£
            const userControlLink = document.createElement('li');
            userControlLink.innerHTML = '<a class="nav-link" href="/template/user_control" title="ç”¨æˆ·ç®¡ç†"><i class="fas fa-users-cog"></i></a>';
            navSelectUl.appendChild(userControlLink);

            const scanBarcodeLink = document.createElement('li');
            scanBarcodeLink.innerHTML = '<a class="nav-link" href="/template/scan_barcode" title="æ‰«ç "><i class="fas fa-barcode"></i></a>';
            navSelectUl.appendChild(scanBarcodeLink);
            
        } else {
            throw new Error('æœªç™»å½•ï¼šç”¨æˆ·åæ— æ•ˆ');
        }


    } catch (error) {
        console.warn('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥æˆ–æœªç™»å½•:', error);
        const loginFalseLink = document.createElement('li');
        loginFalseLink.innerHTML = '<a class="nav-link" href="/user_control/login"><i class="fas fa-right-to-bracket"></i></a>';
        navSelectUl.appendChild(loginFalseLink);
    }
}


function initSocket(username, userId) {
    const socket = io("https://fahui.utbabuddha.com",{
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
    });

    socket.on('connect', () => {
        console.log('Socket connected:', socket.id);
        if (username) {
            socket.emit('join_room', { room: username, user_id: userId });
        }
    });

    socket.on('notice', (data) => {
        console.log(`æ”¶åˆ°é€šçŸ¥:`, data);
        get_PushNotification?.(); // é˜²æ­¢æœªå®šä¹‰é”™è¯¯
        Pushpopup?.(data.msg);
    });

    socket.on('online_users', (list) => {
        console.log('åœ¨çº¿ç”¨æˆ·åˆ—è¡¨:', list);
    });
}


function show_status_mask(status, message = "loading") {
  const existing = document.getElementById('status-mask');

  if (status === 'loading') {
    if (existing) return; // å·²å­˜åœ¨åˆ™ä¸é‡å¤æ·»åŠ 

    const mask = document.createElement('div');
    mask.id = 'status-mask';

    const logo = document.createElement('img');
    logo.src = '/static/images/logo/logo.png';
    logo.alt = 'Loading...';
    logo.className = 'loading-logo';

    // ğŸ‘‡ å¢åŠ æç¤ºæ–‡å­—
    const msg = document.createElement('div');
    msg.className = 'loading-message';
    msg.textContent = message;

    mask.appendChild(logo);
    mask.appendChild(msg);
    document.body.appendChild(mask);

  } else if (status === 'success' && existing) {
    existing.remove();
  }
}


function Pushpopup(message) {
  const popup = document.createElement('div');
  popup.className = 'push-popup';
  popup.textContent = message;

  document.body.appendChild(popup);

  // ä¿å­˜å½“å‰æ ‡é¢˜
  const originalTitle = document.title;
  document.title = message;

  // è®¾ç½®ç‚¹å‡»äº‹ä»¶æ¢å¤æ ‡é¢˜ï¼ˆåªè§¦å‘ä¸€æ¬¡ï¼‰
  const restoreTitle = () => {
    document.title = originalTitle;
    document.removeEventListener('click', restoreTitle);
  };
  document.addEventListener('click', restoreTitle);

  // å±•å¼€åŠ¨ç”»
  requestAnimationFrame(() => {
    popup.classList.add('show');
  });

  // 3 ç§’åå…³é—­å¼¹çª—
  setTimeout(() => {
    popup.classList.remove('show');
    popup.classList.add('fade-out');
    setTimeout(() => popup.remove(), 300);
  }, 3000);
}


function update_navbar(userData, ms) {

  const nameToShow = userData.display_name || userData.username || 'Visitors';

  // æ›´æ–° <body> çš„ data-theme å±æ€§ï¼Œä½¿ç”¨ user_theme
  if (userData.user_theme) {
    document.body.setAttribute('data-theme', userData.user_theme);
  }

  // æ›´æ–° ping_ms æ–‡æœ¬
  const pingElem = document.getElementById('ping_ms');
  if (pingElem) {
    pingElem.textContent = `${nameToShow}:${ms}`;
  }
}



    </script>
    
</body>
</html>
