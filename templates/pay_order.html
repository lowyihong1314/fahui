{% extends "base.html" %}

{% block title %}æ”¯ä»˜{% endblock %}

{% block content %}
<style>
  .payment-options {
    display: flex;
    gap: 16px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 20px;
  }

  .payment-option {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    transition: box-shadow 0.2s ease;
    width: 120px;
    text-align: center;
  }

  .payment-option:hover {
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }

  .payment-option img {
    width: 100px;
    height: 100px;
    object-fit: contain;
  }



/* Modal Overlay */
.modal {
  display: flex;             /* ç”¨ flex å±…ä¸­ */
  justify-content: center;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  overflow-y: auto;          /* è¶…å‡ºæ—¶å…è®¸é¡µé¢æ»šåŠ¨ */
  padding: 20px;             /* ä¿è¯è¾¹è· */
  box-sizing: border-box;
}

/* Dialog Container */
.modal-dialog {
  width: 100%;
  max-width: 400px;
  background: var(--bg-color);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  max-height: 90vh;          /* å¼¹çª—æœ€å¤šå  90% é«˜åº¦ */
  display: flex;
  flex-direction: column;
}

/* Modal Content */
.modal-content {
  padding: 16px;
  color: var(--text-color);
  flex: 1;
  overflow-y: auto;          /* è®©å†…å®¹å¯æ»šåŠ¨ */
}


/* Header */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Close Button */
.modal-close {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: var(--text-color);
}

/* Body */
.modal-body {
  margin-top: 10px;
}

/* Footer */
.modal-footer {
  margin-top: 16px;
  text-align: right;
}

/* Buttons */
.btn-submit {
  background-color: var(--save-button-bg);
  color: var(--button-text-color);
  border: none;
  padding: 6px 12px;
  margin-right: 8px;
  cursor: pointer;
}

.btn-submit:hover {
  background-color: var(--save-button-bg-hover);
}

.btn-cancel {
  background: none;
  color: var(--text-color);
  border: 1px solid var(--border-color);
  padding: 6px 12px;
  cursor: pointer;
}

.btn-cancel:hover {
  background-color: var(--notify-close-hover-bg);
}
/* è¡¨æ ¼æ ·å¼ */
.user-table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid var(--border-color);
}

.user-table th,
.user-table td {
  padding: 10px;
  border: 1px solid var(--border-color);
  text-align: left;
}

.user-table tr.highlight-row {
  background-color: var(--notify-close-hover-bg);
  color: var(--title-color);
}

.user-table tr.clickable {
  cursor: pointer;
}

.user-table tr.clickable:hover {
  background-color: var(--nav-link-hover-color);
  color: var(--button-text-color);
}

/* é®ç½©å±‚ */
.custom-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5); /* åŠé€æ˜é®ç½© */
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* å¼¹å‡ºæ¡†ä¸»ä½“ */
.custom-modal-content {
  background: var(--bg-color);
  color: var(--text-color);
  padding: 30px 20px;
  border-radius: 8px;
  text-align: center;
  position: relative;
  min-width: 300px;
  max-width: 400px;
  border: 1px solid var(--border-color);
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
}

/* å…³é—­æŒ‰é’® */
.custom-close-btn {
  position: absolute;
  top: 5px;
  right: 10px;
  font-size: 24px;
  color: var(--ping-color);
  cursor: pointer;
}

/* æç¤ºæ–‡å­— */
.status-message {
  font-size: 18px;
  margin-bottom: 20px;
  color: var(--text-color);
}

/* ä¸‹è½½æŒ‰é’® */
.download-btn {
  display: inline-block;
  background: var(--edit-button-bg);
  color: var(--button-text-color);
  padding: 10px 15px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: bold;
  transition: background 0.3s ease;
}

.download-btn:hover {
  background: var(--edit-button-bg-hover);
}

</style>

<h2 id="template_title" class="template_title">æ€»åŠŸå¾·é‡‘</h2>

<div id="select_payment_mode" class="payment-options"></div>


<script>
const orderId = '{{order_id}}'

  window.onload = async function() {
    await get_total();
    await check_status();
  };

  async function check_status() {
    try {
      const response = await fetch(`/payment/get_payment_data/${orderId}`);
      const result = await response.json();

      if (result.success && result.data.length > 0) {
        console.log(result);
        const latest = result.data[0];
        const status = latest.status.toLowerCase();

      if (status === 'approve' || status === 'panding') {
        if (latest.login !== true) {   // âœ… åˆ¤æ–­æ˜¯å¦æœªç™»å½•
          show_modal(status);
        }
      }
      }
    } catch (error) {
      console.error('è·å–æ”¯ä»˜ä¿¡æ¯å¤±è´¥:', error);
    }
  }

  function show_modal(status) {
    // é¿å…é‡å¤æ·»åŠ 
    const existingModal = document.getElementById('payment-status-modal');
    if (existingModal) {
      existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.id = 'payment-status-modal';
    modal.className = 'custom-modal-overlay';

    modal.innerHTML = `
      <div class="custom-modal-content">
        ${
          status === 'approve'
            ? `<p class="status-message">æ”¯ä»˜å·²é€šè¿‡å®¡æ ¸ã€‚</p>
               <a href="/payment/download_quotiton/${orderId}" class="download-btn" title="ä¸‹è½½å‘ç¥¨">ğŸ§¾ ä¸‹è½½å‘ç¥¨</a>`
            : `<p class="status-message">æ”¯ä»˜ç­‰å¾…å®¡æ ¸ä¸­ï¼Œè¯·ç¨ååˆ·æ–°é¡µé¢ã€‚<a href="/">ç‚¹å‡»è¿™é‡Œå›åˆ°ä¸»é¡µ</a></p>`
        }
      </div>
    `;

    document.body.appendChild(modal);
  }
  async function get_total() {
    try {
      const res = await fetch(`/payment/calculate_amount/${orderId}`);
      const data = await res.json();

      const amount = data.amount ?? 0;
      const title = document.getElementById("template_title");

      title.textContent = `æ€»åŠŸå¾·é‡‘ RM${amount}`;
      generate_payment_options();
    } catch (err) {
      console.error("è·å–é‡‘é¢å¤±è´¥ï¼š", err);
    }
  }

function generate_payment_options() {
  const container = document.getElementById("select_payment_mode");

  const images = [
    {
      src: "/static/images/bank_transfer.png",
      label: "é“¶è¡Œè½¬è´¦",
      onClick: () => {
        openBankTransferModal();
      }
    },
    {
      src: "/static/images/Pay_cash_icon.jpg",
      label: "ç°é‡‘æ”¯ä»˜",
      onClick: () => {
        do_cash_payment();
      }
    },
    {
      src: "/static/images/TNG_icon.png",
      label: "TNG",
      onClick: () => {
        openTNGModal();
      }
    },
    {
      src: "/static/images/pdf-file-format.png",
      label: "ä¸‹è½½æ˜ç»†",
      onClick: () => {
        download_order_detail();
      }
    }
  ];

  images.forEach(img => {
    const optionDiv = document.createElement('div');
    optionDiv.className = "payment-option";

    const image = document.createElement('img');
    image.src = img.src;
    image.alt = img.label;

    const caption = document.createElement('div');
    caption.textContent = img.label;

    optionDiv.appendChild(image);
    optionDiv.appendChild(caption);

    // ç‚¹å‡»äº‹ä»¶ç»‘å®šå…·ä½“å‡½æ•°
    optionDiv.addEventListener('click', img.onClick);

    container.appendChild(optionDiv);
  });
}

function openBankTransferModal() {
  // åˆ é™¤å·²æœ‰ modalï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  const existingModal = document.getElementById('bankTransferModal');
  if (existingModal) {
    existingModal.remove();
  }

  // åˆ›å»º modal çš„ HTML å­—ç¬¦ä¸²
  const modalHtml = `
    <div class="modal" id="bankTransferModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">é“¶è¡Œè½¬è´¦æ”¯ä»˜</h5>
            <button type="button" class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <p id="amountInfo">åŠ è½½ä¸­...</p>
            <p>
              é“¶è¡Œè´¦å·ä¿¡æ¯:<br />
              Maybank<br />
              PERTUBUHAN PENGANUTAGAMA BUDDHA ULU TIRAM<br />
              <a href="#" onclick="copyToClipboard('501338525918'); return false;">Acc: 501338525918 ç‚¹å‡»å¤åˆ¶</a>
              <small>è¯·åœ¨ Recipient's Reference ä¸­æ³¨æ˜æ‚¨çš„å§“åï¼Œè°¢è°¢</small>
            </p>
            <p>è¯·ä¸Šä¼ æ”¯ä»˜å‡­è¯ï¼ˆå›¾ç‰‡æˆ–PDFï¼‰:</p>
            <input type="file" id="paymentFile" accept="image/*,application/pdf" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-submit" onclick="submitBankPayment('bank')">æäº¤æ”¯ä»˜</button>
            <button type="button" class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>
  `;

  // æ·»åŠ  modal åˆ°é¡µé¢
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  // åŠ è½½é‡‘é¢
  fetch(`/payment/calculate_amount/${orderId}`)
    .then(res => res.json())
    .then(data => {
      const infoEl = document.getElementById('amountInfo');
      if (data.amount !== undefined) {
        infoEl.textContent = `ä½ éœ€è¦æ”¯ä»˜ RM${data.amount}`;
      } else {
        infoEl.textContent = 'æ— æ³•è·å–æ”¯ä»˜é‡‘é¢';
      }
    })
    .catch(() => {
      document.getElementById('amountInfo').textContent = 'è·å–é‡‘é¢å¤±è´¥';
    });
}

function openTNGModal() {
  // åˆ é™¤å·²æœ‰ modalï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  const existingModal = document.getElementById('bankTransferModal');
  if (existingModal) {
    existingModal.remove();
  }

  const modalHtml = `
    <div class="modal" id="bankTransferModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">TNG ç”µå­é’±åŒ…æ”¯ä»˜</h5>
            <p id="amountInfo">åŠ è½½ä¸­...</p>
            <button type="button" class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <p>è¯·æ‰«æä»¥ä¸‹äºŒç»´ç å®Œæˆæ”¯ä»˜ï¼š</p>
            <div style="text-align:center;">
              <img src="/static/images/logo/tngQR_UTBA.jpeg" alt="TNG QR Code" style="max-width:100%; height:auto; border:1px solid var(--border-color); border-radius:4px;" />
            </div>
            <p style="margin-top:10px;">å®Œæˆæ”¯ä»˜åï¼Œè¯·ä¸Šä¼ æ”¯ä»˜æˆªå›¾ï¼š</p>
            <input type="file" id="paymentFile" accept="image/*,application/pdf" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-submit" onclick="submitBankPayment('tng')">æäº¤æ”¯ä»˜</button>
            <button type="button" class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHtml);

    fetch(`/payment/calculate_amount/${orderId}`)
    .then(res => res.json())
    .then(data => {
      const infoEl = document.getElementById('amountInfo');
      if (data.amount !== undefined) {
        infoEl.textContent = `ä½ éœ€è¦æ”¯ä»˜ RM${data.amount}`;
      } else {
        infoEl.textContent = 'æ— æ³•è·å–æ”¯ä»˜é‡‘é¢';
      }
    })
    .catch(() => {
      document.getElementById('amountInfo').textContent = 'è·å–é‡‘é¢å¤±è´¥';
    });
}


function closeModal() {
  const modal = document.getElementById('bankTransferModal');
  if (modal) {
    modal.remove();
  }
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶: ' + text));
}

function set_cash_payment() {
  if (!orderId) {
    alert('æœªæä¾›è®¢å• ID');
    return;
  }

  const formData = new FormData();
  formData.append('payment_mode', 'cash');

  fetch(`/payment/make_payment/${orderId}`, {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      console.log('ç°é‡‘æ”¯ä»˜æˆåŠŸï¼Œæ”¯ä»˜ID:', data.payment_id);
      alert('ç°é‡‘æ”¯ä»˜æˆåŠŸï¼');
      closeModal();
      window.location.reload();

    } else {
      alert('æ”¯ä»˜å¤±è´¥: ' + data.message);
    }
  })
  .catch(err => {
    console.error('è¯·æ±‚é”™è¯¯', err);
    alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}

function submitBankPayment(paymentMode) {
  const fileInput = document.getElementById('paymentFile');
  const file = fileInput.files[0];

  const formData = new FormData();
  formData.append('payment_mode', paymentMode);
  formData.append('file', file);

  fetch(`/payment/make_payment/${orderId}`, {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      console.log('æ”¯ä»˜æˆåŠŸï¼Œæ”¯ä»˜ID:', data.payment_id);
      alert('æ”¯ä»˜æˆåŠŸï¼');
      closeModal();
      window.location.reload();

    } else {
      alert('æ”¯ä»˜å¤±è´¥: ' + data.message);
    }
  })
  .catch(err => {
    console.error('è¯·æ±‚é”™è¯¯', err);
    alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}


function do_cash_payment(orderId) {
  // ç§»é™¤æ—§ modal
  const existingModal = document.getElementById('cashPaymentModal');
  if (existingModal) existingModal.remove();

  // è·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®
  fetch('/user_control/get_all_user_data')
    .then(res => res.json())
    .then(allUsers => {
      // æ„å»ºç”¨æˆ·è¡¨æ ¼è¡Œï¼ˆä¸å†åŒºåˆ† isMeï¼‰
      const rows = allUsers
        .filter(user => user.display_name != null)
        .map(user => `
          <tr>
            <td>${user.display_name}</td>
            <td>${user.phone}</td>
          </tr>
        `).join('');

      const modalHtml = `
        <div class="modal" id="bankTransferModal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">é€‰æ‹©ç”¨æˆ·ï¼ˆç°é‡‘æ”¯ä»˜ï¼‰</h5>
                <button type="button" class="modal-close" onclick="closeModal()">Ã—</button>
              </div>
              <div class="modal-body">
                <table class="user-table">
                  <thead>
                    <tr>
                      <th>ç”¨æˆ·æ˜µç§°</th>
                      <th>æ‰‹æœºå·</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${rows}
                  </tbody>
                </table>
              </div>
              <div class="modal-footer">
                <button class="btn-confirm" onclick="set_cash_payment('${orderId}')">é”å®šæ”¯ä»˜</button>
                <button class="btn-cancel" onclick="closeModal()">å…³é—­</button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
    })
    .catch(error => {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥', error);
      alert('æ— æ³•åŠ è½½ç”¨æˆ·ä¿¡æ¯');
    });
}
function download_order_detail() {
  const url = `/payment/download_quotiton/${orderId}`;
  
  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error('ä¸‹è½½å¤±è´¥');
      return response.blob();
    })
    .then(blob => {
      const link = document.createElement('a');
      const url = window.URL.createObjectURL(blob);
      link.href = url;
      link.download = `order_${orderId}_quotation.pdf`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
    })
    .catch(err => {
      alert('ä¸‹è½½å‡ºé”™: ' + err.message);
    });
}

</script>

{% endblock %}
