{% extends "base.html" %}

{% block title %}æ³•ä¼šç³»ç»Ÿ{% endblock %}

{% block content %}
<style>

#headers {
  display: flex;
  justify-content: center;
  align-items: stretch; /* å…³é”®ï¼šè®©æ‰€æœ‰å­é¡¹åŒé«˜ */
  gap: 10px;
}

#customer_info {
  background-color: var(--bg-color);
  border: 1px solid var(--border-color);
  padding: 16px;
  border-radius: 8px;
  color: var(--text-color);
  font-family: Arial, sans-serif;
  max-width: 400px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

#customer_info p {
  margin: 8px 0;
  color: var(--text-color);
}

#customer_info p:first-child {
  font-weight: bold;
  color: var(--title-color);
}

#order_detail {
  background-color: var(--bg-color);
  padding: 16px;
  border-radius: 8px;
  color: var(--text-color);
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: 20px auto;
}

#order_detail table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 16px;
  border: 1px solid var(--border-color);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
  border-radius: 6px;
  overflow: hidden;
}

#order_detail td {
  padding: 12px;
  border: 1px solid var(--border-color);
  background-color: var(--notify-bg-color);
  color: var(--text-color);
  transition: background-color 0.2s, color 0.2s;
}

#order_detail td a{
  color: var(--text-color);
}

#order_detail td a:hover{
  box-shadow: 0 4px 10px var(--title-color-right);
}

#order_detail tr:first-child td {
  font-weight: bold;
  background-color: var(--nav-bg-color);
  color: var(--title-color);
}

.button_list {
  display: flex;
  justify-content: center;
}

.btn {
  cursor: pointer;
  padding: 8px 12px;
  margin: 5px;
  border-radius: 4px;
  text-decoration: none;
  display: inline-block;
  color: var(--button-text-color);
  transition: background-color 0.2s ease;
  border: none;
}

.btn-save {
  background-color: var(--save-button-bg);
}

.btn-save:hover {
  background-color: var(--save-button-bg-hover);
}

.btn-delete {
  background-color: var(--delete-button-bg);
}

.btn-delete:hover {
  background-color: var(--delete-button-bg-hover);
}

.btn-secondary {
  background-color: var(--save-button-bg);
}

.btn-secondary:hover {
  background-color: var(--save-button-bg-hover);
}

.btn-info {
  background-color: var(--save-button-bg);
}

.btn-primary {
  background-color: var(--save-button-bg);
}

#version {
  display: flex;
  justify-content: center;
  align-items: center;
  max-width: 400px;
  background-color: var(--bg-color);
  border: 1px solid var(--border-color);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  padding: 16px;
}

.version-text {
  font-size: 50px;
  font-weight: bold;
}

/* åŠ¨ç”»æ ·å¼ */
@keyframes versionHighlight {
  0% {
    transform: scale(1);
    background-color: var(--title-color);
    color: var(--button-text-color);
    box-shadow: 0 0 5px var(--title-color);
  }
  50% {
    transform: scale(1.2);
    background-color: var(--title-color-right);
    color: var(--bg-color);
    box-shadow: 0 0 20px var(--title-color-right);
  }
  100% {
    transform: scale(1);
    background-color: transparent;
    color: var(--text-color);
    box-shadow: none;
  }
}

.animate-version {
  animation: versionHighlight 3s ease-in-out;
  border-radius: 8px;
  padding: 4px 12px;
  display: inline-block;
  transition: all 0.3s ease;
}

/* æ¨¡æ€æ¡†é®ç½©å±‚ */
.modal {
  display: none; /* é»˜è®¤éšè— */
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.4); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
}

/* æ¨¡æ€æ¡†å†…å®¹ */
.modal-content {
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 10% auto;
  padding: 20px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  width: 400px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* æ ‡é¢˜ */
.modal-content h2 {
  margin-top: 0;
  color: var(--title-color);
}

/* è¾“å…¥æ¡† */
.modal-content input {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  margin-bottom: 12px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-size: 14px;
  color: var(--text-color);
  background-color: var(--bg-color);
}

/* æŒ‰é’®åŸºç¡€æ ·å¼ */
.modal-content .btn {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  color: var(--button-text-color);
  margin-right: 8px;
  font-size: 14px;
}

/* æäº¤æŒ‰é’® */
.modal-content .btn.save {
  background-color: var(--save-button-bg);
}
.modal-content .btn.save:hover {
  background-color: var(--save-button-bg-hover);
}

/* å…³é—­æŒ‰é’® */
.modal-content .btn.close {
  background-color: var(--delete-button-bg);
}
.modal-content .btn.close:hover {
  background-color: var(--delete-button-bg-hover);
}

/* Footer æ ·å¼ */
#footer {
  margin: auto;
  background-color: var(--bg-color);
  color: var(--text-color);
  padding: 15px;
  border-top: 1px solid var(--border-color);
  font-family: Arial, sans-serif;
  max-width: 900px;
}

/* è¡¨æ ¼æ ·å¼ */
#footer table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
}

#footer table th,
#footer table td {
  border: 1px solid var(--border-color);
  padding: 8px;
  text-align: left;
}

#footer table th {
  background-color: var(--nav-bg-color);
  color: var(--nav-link-color);
}

/* æ€»é¢æ ·å¼ */
#footer > div {
  font-weight: bold;
  margin-bottom: 10px;
  color: var(--title-color);
}

/* æŒ‰é’®æ ·å¼ */
#footer button {
  background-color: var(--edit-button-bg);
  color: var(--button-text-color);
  border: none;
  padding: 8px 16px;
  margin-right: 10px;
  cursor: pointer;
  border-radius: 4px;
  transition: background-color 0.3s;
}

#footer button:hover {
  background-color: var(--edit-button-bg-hover);
}

#footer button:last-child {
  margin-right: 0;
}

#fahui_image_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
}
.pdf-thumbnail {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  transition: transform 0.2s, box-shadow 0.2s;
}

.pdf-thumbnail:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px var(--ping-color);
  transition: transform 0.2s, box-shadow 0.2s;
}

</style>

<h2 id="template_title" class="template_title">å¯å»ºç›‚å…°ç›†å­äº²è¶…åº¦æ³•ä¼š</h2>
<div class="button_list" id="button_list">
  <button onclick="window.location.href = `/template/fahui_input/${orderId}`;" class="btn btn-save">æ·»åŠ ç‰Œä½</button>
  <button onclick="delete_paiwei()" class="btn btn-delete">ç§»é™¤ç‰Œä½</button>
  <button onclick="copy_fahui_data()" class="btn btn-info">å¤åˆ¶ç‰Œä½</button>
</div>
<div id="headers">
  <div id="customer_info"></div>
  <div id="version"></div>
</div>
<div id="fahui_image_container"></div>
<div id="order_detail"></div>

<div id="footer"></div>

<div class="button_list">
    <button onclick="print_paiwei();" class="btn btn-secondary">ä¸‹è½½ç‰Œä½</button>
    <button onclick="window.location.href = `/template/pay_order/${orderId}`;" class="btn btn-secondary">ç‚¹å‡»æ”¯ä»˜</button>
</div>
<div id="edit_customer_info_modal" class="modal">
  <div class="modal-content">
    <h2>ç¼–è¾‘å®¢æˆ·ä¿¡æ¯</h2>
    
    <label>å®¢æˆ·å:</label>
    <input id="edit_customer_name" type="text"><br><br>
    
    <label>ç”µè¯:</label>
    <input id="edit_customer_phone" type="text"><br><br>

    <label>Email:</label>
    <input id="edit_customer_email" type="email"><br><br>

    <button class="btn save" onclick="submitEditCustomerInfo()">æäº¤</button>
    <button class="btn close" onclick="closeEditCustomerInfoModal()">å…³é—­</button>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js"></script>

<script>

const orderId = '{{ order_id }}';

function openEditCustomerInfoModal(data) {
    // å¡«å……ç°æœ‰æ•°æ®
    document.getElementById('edit_customer_name').value = data.customer_name || '';
    document.getElementById('edit_customer_phone').value = data.phone || '';
    document.getElementById('edit_customer_email').value = data.email || '';

    // æ˜¾ç¤º modal
    document.getElementById('edit_customer_info_modal').style.display = 'block';

    // ä¸´æ—¶å­˜å‚¨å½“å‰æ•°æ®
    window.currentCustomerData = data;
}

function closeEditCustomerInfoModal() {
    document.getElementById('edit_customer_info_modal').style.display = 'none';
}

function submitEditCustomerInfo() {
    const updatedData = {
        customer_name: document.getElementById('edit_customer_name').value,
        phone: document.getElementById('edit_customer_phone').value,
        email: document.getElementById('edit_customer_email').value,
    };

    fetch(`/api/update_customer/${orderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            show_alert("success", "Edit success");
            closeEditCustomerInfoModal();
            fetchOrderDetail();
            // å¯æ ¹æ®éœ€è¦åˆ·æ–°é¡µé¢æˆ–æ›´æ–°å‰ç«¯æ˜¾ç¤º
        } else {
            show_alert("error", data.message);
        }
    })
    .catch(err => console.error("è¯·æ±‚å‡ºé”™:", err));
}

function print_paiwei() {
  const a = document.createElement('a');
  a.href = `/print_paiwei/preview_order/${orderId}`;   // åç«¯è¿”å› PDF
  a.download = `paiwei_order_${orderId}.pdf`; // ä¸‹è½½çš„æ–‡ä»¶å
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}


async function delete_paiwei() {
  const id = orderId;
  console.log(id);
  if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤ç‰Œä½è®¢å•ï¼Ÿ")) return;

  try {
    const res = await fetch(`/api/delete_orders`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        data: [{ id: id }]
      })
    });

    const result = await res.json();

    if (result.status === "delete successfully") {
      // åˆ é™¤æˆåŠŸ â†’ è·³è½¬
      window.location.href = "/template/fahui_data";
    } else {
      alert("åˆ é™¤å¤±è´¥ï¼š" + (result.message || "æœªçŸ¥é”™è¯¯"));
    }
  } catch (err) {
    console.error("è¯·æ±‚å‡ºé”™ï¼š", err);
    alert("åˆ é™¤è¯·æ±‚å¤±è´¥ï¼");
  }
}


async function copy_fahui_data() {
  try {
    const res = await fetch('/api/copy_old_data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        order_id: orderId
      })
    });

    const result = await res.json();

    if (res.ok && result.new_order_id) {
      // è·³è½¬åˆ°æ–°è®¢å•è¯¦æƒ…é¡µ
      window.location.href = `/template/show_order_detail/${result.new_order_id}`;
    } else {
      alert("å¤åˆ¶å¤±è´¥ï¼š" + (result.error || "æœªçŸ¥é”™è¯¯"));
    }
  } catch (err) {
    console.error("è¯·æ±‚å¤±è´¥ï¼š", err);
    alert("è¯·æ±‚å‡ºé”™ï¼");
  }
}

function fetchOrderDetail() {
    console.log(`æŸ¥çœ‹è¯¦æƒ… - ID: ${orderId}`);

    fetch(`/api/get_order_detail?id=${orderId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error("è®¢å•æœªæ‰¾åˆ°");
            }
            return response.json();
        })
        .then(data => {
            console.log("è®¢å•è¯¦ç»†ä¿¡æ¯ï¼š", data);
            generateCustomerInfo(data);
        })
        .catch(error => {
            console.error("è¯·æ±‚å‡ºé”™ï¼š", error);
        });
}

function generateCustomerInfo(data) {
    const customerInfo = document.getElementById('customer_info');
    const versionContainer = document.getElementById('version');

    // å»æ‰ version åé¢çš„ _YLPï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const cleanVersion = (data.version || '').split('_')[0];

    customerInfo.innerHTML = `
        <div id="customer_info_content" style="cursor: pointer;">
            <p>å®¢æˆ·å: ${data.customer_name || ''}</p>
            <p>ç”µè¯: ${data.phone  || ''}</p>
            <p>Email: ${data.email  || ''}</p>
            <p>æ³•ä¼šæ—¶é—´: ${data.date || ''}</p>
        </div>
    `;

    versionContainer.innerHTML = `<div class="version-text">${cleanVersion}</div>`;
    highlightVersion();

    generateOrderItems(data);

    // ç»‘å®šç‚¹å‡»äº‹ä»¶ -> æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
    document.getElementById('customer_info_content').onclick = () => {
        openEditCustomerInfoModal(data);
    };
}

function highlightVersion() {
  const versionText = document.querySelector('#version');
  if (!versionText) return;

  versionText.classList.remove('animate-version');
  void versionText.offsetWidth; // è§¦å‘é‡ç»˜
  versionText.classList.add('animate-version');
}


function generateOrderItems(data) {
  const orderDetail = document.getElementById('order_detail');
  const itemData = data.order_items;

  orderDetail.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

  itemData.forEach(item => {
    const table = document.createElement('table');
    table.classList.add('order-item-table');  // å¯é€‰ï¼šåŠ æ ·å¼ç±»

    // æ·»åŠ ä¸»å­—æ®µä½œä¸ºä¸€è¡Œ
    const mainRow = document.createElement('tr');

    const mainFields = [
      { label: 'é¡¹ç›®å', value: get_fahui_type(item.code) }, 
      { label: 'åŠŸå¾·é‡‘', value: item.price },
      { label: 'Type', value: item.code }
    ];

    mainFields.forEach(field => {
      const td = document.createElement('td');
      td.textContent = `${field.label}: ${field.value ?? ''}`;
      td.onclick = () =>  console.log(field.value, field.id);
      mainRow.appendChild(td);
    });

    // âœ… æ·»åŠ åˆ é™¤æŒ‰é’®åˆ—
    const deleteCell = document.createElement('td');
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = "åˆ é™¤";
    deleteBtn.className = "btn btn-delete"; // å¯é€‰ï¼šæŒ‰é’®æ ·å¼
    deleteBtn.onclick = () => delete_item(item.id);  // è°ƒç”¨ä½ çš„ delete_item å‡½æ•°

    deleteCell.appendChild(deleteBtn);
    mainRow.appendChild(deleteCell);

    table.appendChild(mainRow);

    // æ·»åŠ  item_form_data å­—æ®µä¸ºå¤šè¡Œï¼ˆkey/valueï¼‰
    const formData = item.item_form_data || {};
      for (const [key, valueList] of Object.entries(formData)) {
        if (!Array.isArray(valueList)) continue;

        const formRow = document.createElement('tr');

        const keyCell = document.createElement('td');
        keyCell.textContent = get_label_cn(key);

        const valueCell = document.createElement('td');
        valueCell.colSpan = mainFields.length;
        valueCell.style.cursor = "default"; // æ•´ä¸ªå•å…ƒæ ¼ä¸è§¦å‘äº‹ä»¶ï¼Œç”±<a>è´Ÿè´£
        valueCell.innerHTML = '';

        valueList.forEach(({ val, val_id }) => {
          const a = document.createElement('a');
          a.href = '#';
          a.textContent = val ?? '';

          a.onclick = (e) => {
            e.preventDefault();
            edit_OrderItem(val, val_id);
          };

          valueCell.appendChild(a);
        });

        formRow.appendChild(keyCell);
        formRow.appendChild(valueCell);
        table.appendChild(formRow);
      }

    orderDetail.appendChild(table);
  });
  generate_footer(data);
}

function generate_footer(data) {
    const container = document.getElementById('footer');
    container.innerHTML = ''; // æ¸…ç©ºä¹‹å‰å†…å®¹

    if (!data || !data.order_items || data.order_items.length === 0) {
        container.textContent = "æ²¡æœ‰è®¢å•é¡¹";
        return;
    }

    // 1. åˆ›å»ºè¡¨æ ¼
    const table = document.createElement('table');
    table.classList.add('order-footer-table');

    // è¡¨å¤´
    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    ['é¡¹ç›®', 'åŠŸå¾·é‡‘', 'ä½ç½®å·ç '].forEach(text => {  // âœ… æ–°å¢ä¸€åˆ—
        const th = document.createElement('th');
        th.textContent = text;
        headRow.appendChild(th);
    });
    thead.appendChild(headRow);
    table.appendChild(thead);

    // è¡¨èº«
    const tbody = document.createElement('tbody');
    let total = 0;

    data.order_items.forEach(item => {
        const tr = document.createElement('tr');

        // é¡¹ç›®
        const tdName = document.createElement('td');
        tdName.textContent = get_fahui_type(item.code) || item.item_name || "æœªå‘½å";

        // ä»·æ ¼ï¼ˆå¥å£®å¤„ç†ï¼‰
        let price = 0;
        if (item.code === "D" && item.item_form_data && item.item_form_data.price) {
            const prices = item.item_form_data.price.map(p => Number(p.val) || 0);
            price = prices.length > 1 ? prices.reduce((a, b) => a + b, 0) : prices[0];
        } else {
            price = Number(item.price) || 0;
        }

        const tdPrice = document.createElement('td');
        tdPrice.textContent = price.toFixed(2);

        // âœ… ä½ç½®å·ç 
        // âœ… ä½ç½®å·ç ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼‰
        let locationNumbers = "";
        if (item.item_location && item.item_location.length > 0) {
            locationNumbers = item.item_location
                .map(loc => (loc.pdf_page_data && loc.pdf_page_data.print_pdf_id) ? loc.pdf_page_data.print_pdf_id : null)
                .filter(id => id !== null)   // è¿‡æ»¤æ‰æ— æ•ˆå€¼
                .join(",");                  // æ‹¼æˆ "123,456,78"
        }

        const tdLocation = document.createElement("td");
        tdLocation.textContent = locationNumbers || "-";

        // æ‹¼è£…è¡Œ
        tr.appendChild(tdName);
        tr.appendChild(tdPrice);
        tr.appendChild(tdLocation);
        tbody.appendChild(tr);

        total += price;
    });

    table.appendChild(tbody);

    container.appendChild(table);

    // 2. æ˜¾ç¤ºæ€»é¢
    const totalDiv = document.createElement('div');
    totalDiv.classList.add('order-total');
    totalDiv.textContent = `æ€»åŠŸå¾·é‡‘: ${total.toFixed(2)}`;
    container.appendChild(totalDiv);

    // 3. åˆ›å»ºæŒ‰é’®å®¹å™¨
    if (data.login) {
        const btnContainer = document.createElement('div');
        btnContainer.classList.add('order-footer-buttons');

        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'ä¸Šä¸€æ¡';
        if (data.prev_id) {
            prevBtn.onclick = () => window.location.href = `/template/show_order_detail/${data.prev_id}`;
        } else {
            prevBtn.disabled = true;
        }

        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'ä¸‹ä¸€æ¡';
        if (data.next_id) {
            nextBtn.onclick = () => window.location.href = `/template/show_order_detail/${data.next_id}`;
        } else {
            nextBtn.disabled = true;
        }

        const printBtn = document.createElement('button');
        printBtn.textContent = "ğŸ–¨ æ‰“å°æ”¶æ®";
        printBtn.className = "print-btn";
        printBtn.onclick = async () => {
            if (confirm("æ˜¯å¦è¦æ‰“å°æ”¶æ®ï¼Ÿ")) {
                try {
                    const res = await fetch(`/payment/print_receipt/${orderId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }
                    });
                    const printData = await res.json();
                    if (printData.success) {
                        Pushpopup("âœ… æ”¶æ®å·²å‘é€æ‰“å°æœº");
                    } else {
                        Pushpopup("âŒ æ‰“å°å¤±è´¥: " + (printData.message || "æœªçŸ¥é”™è¯¯"));
                    }
                } catch (err) {
                    console.error("æ‰“å°å‡ºé”™:", err);
                    Pushpopup("âŒ è¯·æ±‚å¼‚å¸¸ï¼Œæ‰“å°å¤±è´¥");
                }
            } else {
                // å¦‚æœåªæ˜¯è¦åŸæ¥çš„è¯¦æƒ…è·³è½¬ï¼Œå¯ä»¥æ”¾è¿™é‡Œ
                Pushpopup("âŒ è¯·æ±‚å¼‚å¸¸ï¼Œæ‰“å°å¤±è´¥");
            }
        };

        btnContainer.appendChild(prevBtn);
        btnContainer.appendChild(nextBtn);
        btnContainer.appendChild(printBtn);  // æ·»åŠ æ‰“å°æŒ‰é’®åˆ°æŒ‰é’®å®¹å™¨
        container.appendChild(btnContainer);
        generate_paiwei_preview();
    }
}
async function generate_paiwei_preview() {
  const container = document.getElementById("fahui_image_container");
  container.innerHTML = "åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...";

  try {
    const url = `/print_paiwei/preview_order/${orderId}`;
    const pdf = await pdfjsLib.getDocument(url).promise;

    container.innerHTML = ""; // æ¸…ç©º

    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const scale = 1.5;
      const viewport = page.getViewport({ scale });

      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      await page.render({ canvasContext: context, viewport }).promise;

      // ç”Ÿæˆç¼©ç•¥å›¾
      const img = document.createElement("img");
      img.src = canvas.toDataURL("image/png");
      img.style.width = "150px";
      img.style.height = "150px";
      img.style.objectFit = "cover";
      img.style.margin = "5px";
      img.style.cursor = "pointer";
      img.classList.add("pdf-thumbnail");

      // ç‚¹å‡»æ”¾å¤§
      img.onclick = () => {
        const overlay = document.createElement("div");
        overlay.style.position = "fixed";
        overlay.style.top = 0;
        overlay.style.left = 0;
        overlay.style.width = "100vw";
        overlay.style.height = "100vh";
        overlay.style.backgroundColor = "rgba(0,0,0,0.8)";
        overlay.style.display = "flex";
        overlay.style.justifyContent = "center";
        overlay.style.alignItems = "center";
        overlay.style.zIndex = 1000;

        const fullImg = document.createElement("img");
        fullImg.src = img.src;
        fullImg.style.maxWidth = "90%";
        fullImg.style.maxHeight = "90%";
        fullImg.style.boxShadow = "0 0 20px #000";
        fullImg.style.cursor = "pointer";

        overlay.onclick = () => overlay.remove();

        overlay.appendChild(fullImg);
        document.body.appendChild(overlay);
      };

      container.appendChild(img);
    }
  } catch (err) {
    console.error("è¯·æ±‚å‡ºé”™:", err);
    container.innerHTML = `<p style="color:red;">è¯·æ±‚å‡ºé”™ âŒ</p>`;
  }
}

async function edit_OrderItem(value, id) {
  const newValue = prompt("è¯·è¾“å…¥ï¼š", value);
  if (newValue === null || newValue.trim() === "") return;

  try {
    const res = await fetch('/api/update_item_form_value', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: id,
        value: newValue.trim()
      })
    });

    const result = await res.json();

    if (res.ok && result.success) {
      alert("ä¿®æ”¹æˆåŠŸï¼");
      location.reload(); // æˆ–å±€éƒ¨åˆ·æ–°
    } else {
      alert("ä¿®æ”¹å¤±è´¥ï¼š" + (result.message || "æœªçŸ¥é”™è¯¯"));
    }
  } catch (err) {
    console.error("è¯·æ±‚å¤±è´¥ï¼š", err);
    alert("è¯·æ±‚å‡ºé”™ï¼");
  }
}

function delete_item(item_id) {
  if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®ï¼Ÿ")) return;

  fetch(`/api/delete_item/${item_id}/${orderId}`, {
    method: "DELETE"
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      show_alert('success','delete success');
      // é‡æ–°åŠ è½½æˆ–åˆ·æ–°æ•°æ®
      fetchOrderDetail();
    } else {
      show_alert("error",data.message);
    }
  })
  .catch(err => {
    console.error("åˆ é™¤å‡ºé”™ï¼š", err);
    alert("ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸");
  });
}


window.onload = function() {
    fetchOrderDetail();
};

</script>
{% endblock %}
