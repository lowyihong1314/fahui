{% extends "base.html" %}

{% block title %}æ‰¾æ’ä½{% endblock %}

{% block content %}
<style>
#group_container{
    max-width: 100%;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    padding: 20px;
    gap: 20px;
}
/* å•ä¸ªç™½æ¿ */
.white_board {
  flex: 1 1 300px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background-color: var(--notify-bg-color);
  padding: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: box-shadow 0.2s ease-in-out;
}

.white_board:hover {
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* æ ‡é¢˜ */
.board_title {
  font-size: 1.2rem;
  font-weight: bold;
  margin: 0 0 10px 0;
  color: var(--title-color);
  border-bottom: 1px solid var(--border-color);
  padding-bottom: 6px;
}

/* PDF åŒºåŸŸ */
.pdf_area {
  min-height: 80px;
  padding: 8px;
  border-radius: 6px;
  background-color: var(--bg-color);
  border: 1px dashed var(--border-color);
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start; /* æ¯å¼  pdf_paper ä»¥è‡ªèº«é«˜åº¦ä¸ºå‡† */
}

/* å•ä¸ª PDF çº¸å¼  */
.pdf_paper {
  position: relative;
  background-color: var(--notify-bg-color);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  margin: 8px auto;
  overflow: hidden;

  /* âš¡ å›ºå®šæ¯”ä¾‹ä¸º A4 */
  aspect-ratio: 210 / 297;   /* æµè§ˆå™¨æ”¯æŒ aspect-ratio */
  width: 100%;               /* é»˜è®¤å æ»¡å®¹å™¨å®½åº¦ */
  display: flex;
  align-items: center;
  justify-content: center;

  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.pdf_paper:hover {
  transform: scale(1.03);
  border-color: var(--nav-link-hover-color);
}

/* PDF æ ‡é¢˜ */
.pdf_title {
  margin: 0;
  font-size: 0.9rem;
  color: var(--text-color);
  text-align: center;
}
/* å ä½æç¤º */
.empty_notice {
  font-size: 0.9rem;
  color: var(--ping-color);
  text-align: center;
  padding: 16px 0;
}

.pdf_modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.pdf_modal_content {
  background: var(--notify-bg-color);
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  min-width: 300px;
  color: var(--text-color);
}

.Input {
  width: 100%;
  margin-top: 10px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background-color: var(--border-color);
  color: var(--text-color);
  font-size: larger;
}

.context-menu {
  position: absolute;
  background: var(--bg-color);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  z-index: 9999;
  min-width: 150px;
  font-size: 14px;
  color: var(--text-color);
}

.context-menu-item {
  padding: 8px 12px;
  cursor: pointer;
}

.context-menu-item:hover {
  background-color: var(--nav-link-hover-color);
  color: var(--button-text-color);
}

/* é’ˆå¯¹ä¸åŒåŠ¨ä½œåŠ é¢œè‰²æç¤ºï¼ˆå¯é€‰ï¼‰ */
.context-menu-item.delete_pdf:hover {
  background-color: var(--delete-button-bg-hover);
  color: var(--button-text-color);
}
.context-menu-item.edit_pdf:hover {
  background-color: var(--edit-button-bg-hover);
  color: var(--button-text-color);
}
.context-menu-item.download_pdf:hover {
  background-color: var(--save-button-bg-hover);
  color: var(--button-text-color);
}

.search_container {
  display: flex;
  justify-content: center;
  margin-top: 20px;
  gap: 10px;
}

.search_container input {
  padding: 12px 16px;
  border: 1px solid var(--border-color);
  background-color: var(--bg-color);
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  border-radius: 6px;
  width: 50%;
  color: var(--text-color);
  font-size: 18px;
  transition: all 0.3s ease;
}

.search_container input:focus {
  outline: none;
  border-color: var(--title-color);
  box-shadow: 0 0 8px var(--title-color);
}

.search_container button {
  padding: 12px 24px;
  border: none;
  border-radius: 6px;
  background: linear-gradient(135deg, var(--title-color), var(--title-color-right));
  color: var(--button-text-color);
  font-size: 16px;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.search_container button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.search_container button:active {
  transform: scale(0.96);
}

/* é®ç½© */
.detail_modal_overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.detail_modal {
  position: fixed;   /* âœ… æ”¹æˆ fixed */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--bg-color);
  border-radius: 8px;
  padding: 10px;
  min-width: 600px;
  max-width: 80%;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  z-index: 99999999;
}

/* å¤´éƒ¨ï¼ˆå¯æ‹–åŠ¨åŒºåŸŸï¼‰ */
.detail_modal_head {
  background: linear-gradient(90deg, var(--title-color), var(--title-color-right));
  color: var(--button-text-color);
  padding: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  user-select: none;
  cursor: move;   /* åªæœ‰å¤´éƒ¨å¯ä»¥æ‹–åŠ¨ */
  font-weight: bold;
}

.detail_modal_head button {
  background: transparent;
  border: none;
  color: var(--button-text-color);
  font-size: 16px;
  cursor: pointer;
  transition: color 0.2s;
}

.detail_modal_head button:hover {
  color: var(--nav-link-hover-color);
}

/* è¡¨æ ¼ */
.detail_modal table {
  width: 100%;
  border-collapse: collapse;
}

.detail_modal table th {
  background: var(--nav-bg-color);
  color: var(--nav-link-color);
  font-weight: 600;
}

.detail_modal table th,
.detail_modal table td {
  padding: 8px;
  border: 1px solid var(--border-color);
  text-align: left;
}

.detail_modal table tr:nth-child(even) {
  background: var(--notify-bg-color);
}

.detail_modal tbody tr:hover{
  cursor: pointer;
  background: var(--ping-color);
}
/* æ™®é€šé«˜äº® */
.highlight {
  box-shadow: 0 0 15px 5px var(--title-color);
  border-radius: 5px;
  transition: box-shadow 0.3s ease-in-out;
}

.image_modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.image_modal_img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
  box-shadow: 0 0 15px var(--title-color);
}

.image_modal_close {
  position: absolute;
  top: 20px;
  right: 30px;
  font-size: 30px;
  color: white;
  cursor: pointer;
}
.fa-magnifying-glass {
  color: var(--edit-button-bg);
  transition: transform 0.2s, color 0.2s;
}
.fa-magnifying-glass:hover {
  color: var(--edit-button-bg-hover);
  transform: scale(1.2);
}
/* æ‹–èµ·æ¥çš„å…ƒç´  */
.sortable-chosen {
  opacity: 0.6;
  transform: scale(1.05);
  transition: transform 0.2s ease, opacity 0.2s ease;
}

/* å ä½å…ƒç´  */
.sortable-ghost {
  background: var(--nav-bg-color);
  border: 2px dashed var(--title-color);
  min-height: 50px;
  opacity: 0.4;
}


/* æ‹–åŠ¨æ—¶çš„å ä½å…ƒç´ ï¼ˆå ä½åœ¨åŸä½ç½®ï¼‰ */
.drag-ghost {
  opacity: 0.3;
  border: 2px dashed var(--title-color-right);
  background: var(--nav-bg-color);
}
/* æ‹–åŠ¨æ—¶å®é™…è·Ÿéšé¼ æ ‡çš„å…ƒç´  */
.drag-fallback {
  opacity: 0.6;
  transform: rotate(2deg);
  background: var(--nav-link-hover-color);
  color: #fff;
  z-index: 9999;
}

/* è¢«é€‰ä¸­å¼€å§‹æ‹–åŠ¨çš„å…ƒç´  */
.drag-chosen {
  opacity: 0.6;
  border: 2px dashed var(--title-color);
}

.pdf_paper {
  min-width: 110px;
  min-height: 80px;
  box-sizing: border-box;
}
.order-id-label {
  position: absolute;
  top: 2px;
  left: 4px;
  padding: 2px 5px;
  font-size: 10px;
  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  border-radius: 3px;
  z-index: 2;
}
.order-table-container {
  max-height: 300px;   /* âœ… é™åˆ¶è¡¨æ ¼å†…å®¹é«˜åº¦ */
  overflow-y: auto;    /* âœ… è¡¨æ ¼å†…å®¹å¯æ»šåŠ¨ */
  border: 1px solid #ddd;
  margin-top: 10px;
}

.order-detail-table {
  width: 100%;
  border-collapse: collapse;
}

.order-detail-table th,
.order-detail-table td {
  border: 1px solid #ddd;
  padding: 6px 8px;
  text-align: left;
}

.order-detail-table thead th {
  position: sticky;  /* âœ… è¡¨å¤´å›ºå®š */
  top: 0;
  background: #f5f5f5;
  z-index: 1;
}

.order-footer {
  margin-top: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.print-btn {
  background: #007bff;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
}
.print-btn:hover {
  background: #0056b3;
}


</style>
<div class="search_container"><input type="text"  onkeydown="if(event.key === 'Enter'){ search_paiwei(); }" id="search_paiwei_input"><button onclick="search_paiwei()">Search</button><button onclick="show_qr_code()">App</button></div>
<div id="group_container"></div>
<!-- PDF è¾“å…¥ Modal -->
<div id="pdfModal" class="pdf_modal" style="display:none;">
  <div class="pdf_modal_content">
    <h3>è¯·è¾“å…¥ PDF ID</h3>
    <input type="text" id="pdfInput" class="Input" placeholder="è¾“å…¥ PDF ID" />
    <div class="pdf_modal_buttons">
      <button id="pdfSaveBtn">ä¿å­˜</button>
      <button id="pdfCloseBtn">å…³é—­</button>
    </div>
  </div>
</div>

<!-- åœ¨é¡µé¢é‡Œå¼•å…¥ pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>

let group_data = [];
let socket = io("https://fahui.utbabuddha.com", {
    transports: ["websocket"],   // å¼ºåˆ¶ç”¨ websocket é¿å…è½®è¯¢é—®é¢˜
    withCredentials: true        // å¦‚æœè·¨åŸŸéœ€è¦ cookie
});

// âš¡ ç›‘å¬åç«¯å¹¿æ’­çš„æ¶ˆæ¯
socket.on("fahui_dash_board", function(data) {
    console.log("ğŸ“¡ æ”¶åˆ°æ›´æ–°:", data);

    if (data.all_board) {
        group_data = data.all_board;  // æ›´æ–°å…¨å±€æ•°æ®
        generate_fahui_board();       // é‡æ–°æ¸²æŸ“ç™½æ¿
    }
});

// âš¡ é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.onload = async function() {
    try {
        const response = await fetch("/api/list_all", {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        });

        if (!response.ok) throw new Error("è·å–ç™½æ¿åˆ—è¡¨å¤±è´¥");

        const res = await response.json();
        if (res.all_board) {
            group_data = res.all_board;  
            generate_fahui_board();
        } else {
            console.warn("è¿”å›æ•°æ®ä¸­æ²¡æœ‰ all_board:", res);
        }
    } catch (err) {
        console.error("åŠ è½½ç™½æ¿å‡ºé”™:", err);
    }
};
function show_qr_code() {
  console.log("button click")
  const url = "https://fahui.utbabuddha.com/print_paiwei/download_app";

  // å¦‚æœå·²æœ‰ modalï¼Œå…ˆåˆ æ‰
  const old = document.getElementById("QR_modal");
  if (old) old.remove();

  // åˆ›å»º modal
  const modal = document.createElement("div");
  modal.id = "QR_modal";
  modal.style.position = "fixed";
  modal.style.top = "0";
  modal.style.left = "0";
  modal.style.width = "100%";
  modal.style.height = "100%";
  modal.style.background = "rgba(0,0,0,0.5)";
  modal.style.display = "flex";
  modal.style.alignItems = "center";
  modal.style.justifyContent = "center";
  modal.style.zIndex = "9999";

  // åˆ›å»ºäºŒç»´ç å®¹å™¨
  const qrDiv = document.createElement("div");
  qrDiv.id = "qrcode";
  qrDiv.style.padding = "20px";
  qrDiv.style.background = "#fff";
  qrDiv.style.borderRadius = "10px";
  qrDiv.style.cursor = "pointer"; // é¼ æ ‡å˜æˆç‚¹å‡»
  qrDiv.onclick = () => modal.remove(); // ç‚¹å‡»å…³é—­

  modal.appendChild(qrDiv);
  document.body.appendChild(modal);

  // ç”ŸæˆäºŒç»´ç 
  new QRCode(qrDiv, {
    text: url,
    width: 220,
    height: 220
  });
}


let currentBoardId = null;
let currentBoardName = null;


async function search_paiwei(){
  const input = document.getElementById("search_paiwei_input").value.trim();
  if(!input){
    console.log("è¯·è¾“å…¥æœç´¢å†…å®¹");
    return;
  }
  show_status_mask('loading');

  try {
    const res = await fetch(`/api/search_orders_data?value=${encodeURIComponent(input)}`, {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) {
      throw new Error("è¯·æ±‚å¤±è´¥ " + res.status);
    }

    const data = await res.json();
    if (data.length > 0) {
      console.log("æœç´¢ç»“æœ:", data);
      all_detail_modal(data);
      show_status_mask('success');
    } else {
      console.log("æ²¡æœ‰æ‰¾åˆ°ç»“æœ");
      show_status_mask('success');
    }
  } catch (err) {
    console.error("æœç´¢é”™è¯¯:", err);
    show_status_mask('success');
  }
}

function renderOrderTable(order) {
  const wrapper = document.createElement("div");
  wrapper.className = "order-detail-wrapper";

  // é¡¶éƒ¨åŸºæœ¬ä¿¡æ¯
  const infoDiv = document.createElement("div");
  infoDiv.className = "order-basic-info";
  infoDiv.innerHTML = `
    <p><strong>æ–½ä¸»å§“åï¼š</strong>${order.customer_name || "-"}</p>
    <p><strong>è”ç³»ç”µè¯ï¼š</strong>${order.phone || "-"}</p>
    <p><strong>è®¢å•IDï¼š</strong>${order.id}</p>
    <p><strong>ä¸‹å•æ—¶é—´ï¼š</strong>${order.created_at}</p>
  `;
  wrapper.appendChild(infoDiv);

  // è¡¨æ ¼å®¹å™¨ï¼ˆåŠ æ»šåŠ¨ï¼‰
  const tableContainer = document.createElement("div");
  tableContainer.className = "order-table-container";

  const table = document.createElement("table");
  table.className = "order-detail-table";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr>
      <th>ä»£ç </th>
      <th>é¡¹ç›®</th>
      <th>ä¸»è¦ä¿¡æ¯</th>
      <th>åŠŸå¾·é‡‘</th>
      <th>æ“ä½œ</th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  let total = 0;
  (order.order_items || []).forEach(item => {
    const tr = document.createElement("tr");

    const tdCode = document.createElement("td");
    tdCode.textContent = get_fahui_type(item.code);
    tdCode.onclick = () => find_paiwei(item);
    tr.appendChild(tdCode);

    const tdName = document.createElement("td");
    tdName.textContent = item.item_name || "-";
    tdName.onclick = () => find_paiwei(item);
    tr.appendChild(tdName);

    const tdInfo = document.createElement("td");
    let info = "-";
    if (item.item_form_data) {
      if (item.item_form_data.owner?.length) {
        info = item.item_form_data.owner.map(o => o.val).join("ã€");
      } else if (item.item_form_data.deceased?.length) {
        info = item.item_form_data.deceased.map(d => d.val).join("ã€");
      } else {
        const keys = Object.keys(item.item_form_data);
        if (keys.length > 0) {
          const first = item.item_form_data[keys[0]][0];
          info = first?.val || "-";
        }
      }
    }
    tdInfo.textContent = info;
    tdInfo.onclick = () => find_paiwei(item);
    tr.appendChild(tdInfo);

    const tdPrice = document.createElement("td");
    tdPrice.textContent = (item.price || 0).toFixed(2);
    tr.appendChild(tdPrice);

    total += (item.price || 0);

    const tdDetail = document.createElement("td");
    const detailIcon = document.createElement("i");
    detailIcon.className = "fa-solid fa-magnifying-glass";
    detailIcon.style.cursor = "pointer";
    detailIcon.title = "æŸ¥çœ‹è¯¦æƒ…";
    tdDetail.onclick = (e) => {
      e.stopPropagation();
      window.open(`/template/show_order_detail/${order.id}`, "_blank");
    };
    tdDetail.appendChild(detailIcon);
    tr.appendChild(tdDetail);

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  tableContainer.appendChild(table);
  wrapper.appendChild(tableContainer);

  // âœ… åˆè®¡ + æŒ‰é’®åŒº
  const footer = document.createElement("div");
  footer.className = "order-footer";

  const totalDiv = document.createElement("div");
  totalDiv.className = "order-total";
  totalDiv.textContent = `åˆè®¡åŠŸå¾·é‡‘ï¼š${total.toFixed(2)}`;
  footer.appendChild(totalDiv);

  const btnDiv = document.createElement("div");
  btnDiv.className = "order-actions";
  const printBtn = document.createElement("button");
  printBtn.textContent = "ğŸ–¨ æ‰“å°æ”¶æ®";
  printBtn.className = "print-btn";
  printBtn.onclick = async () => {
    if (confirm("æ˜¯å¦è¦æ‰“å°æ”¶æ®ï¼Ÿ")) {
      try {
        const res = await fetch(`/payment/print_receipt/${order.id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();
        if (data.success) {
          Pushpopup("âœ… æ”¶æ®å·²å‘é€æ‰“å°æœº");
        } else {
          Pushpopup("âŒ æ‰“å°å¤±è´¥: " + (data.message || "æœªçŸ¥é”™è¯¯"));
        }
      } catch (err) {
        console.error("æ‰“å°å‡ºé”™:", err);
        Pushpopup("âŒ è¯·æ±‚å¼‚å¸¸ï¼Œæ‰“å°å¤±è´¥");
      }
    } else {
      // å¦‚æœåªæ˜¯è¦åŸæ¥çš„è¯¦æƒ…è·³è½¬ï¼Œå¯ä»¥æ”¾è¿™é‡Œ
      window.open(`/template/show_order_detail/${order.id}`, "_blank");
    }
  };
  btnDiv.appendChild(printBtn);
  footer.appendChild(btnDiv);

  wrapper.appendChild(footer);

  return wrapper;
}



// modal æ¸²æŸ“
function all_detail_modal(data) {
  let currentIndex = 0;

  const modal = document.createElement("div");
  modal.className = "detail_modal";

  function renderPage(index) {
    const order = data[index];
    if (!order) return;
    modal.innerHTML = "";

    // å¤´éƒ¨
    const head = document.createElement("div");
    head.className = "detail_modal_head";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "âŸ¨ ä¸Šä¸€é¡µ";
    prevBtn.onclick = () => {
      if (currentIndex > 0) {
        currentIndex--;
        renderPage(currentIndex);
      }
    };

    const title = document.createElement("span");
    title.textContent = `è®¢å• ID: ${order.id}`;

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "ä¸‹ä¸€é¡µ âŸ©";
    nextBtn.onclick = () => {
      if (currentIndex < data.length - 1) {
        currentIndex++;
        renderPage(currentIndex);
      }
    };

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "âœ•";
    closeBtn.onclick = () => modal.remove();

    head.appendChild(prevBtn);
    head.appendChild(title);
    head.appendChild(nextBtn);
    head.appendChild(closeBtn);

    modal.appendChild(head);
    makeModalDraggable(modal, head);

    // âœ… æ’å…¥è¡¨æ ¼
    modal.appendChild(renderOrderTable(order));
  }

  renderPage(currentIndex);
  document.body.appendChild(modal);
}

// å•ç‹¬çš„é«˜äº®å‡½æ•°
function highlight_pdf(side_id, board_id) {
  const el = document.getElementById(`pdf_id_${side_id}`);
  if (!el) {
    console.warn(`âš ï¸ æœªæ‰¾åˆ° pdf_id_${side_id}`);
    return;
  }

  el.classList.add("highlight");
  el.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });

  const parent = el.parentElement;
  if (parent) {
    // æ¯æ¬¡è°ƒç”¨å…ˆæ¸…æ‰ä¸Šæ¬¡çš„ shadowï¼Œä¿è¯å¯ä»¥é‡æ–°ç‚¹äº®
    parent.style.boxShadow = "none";

    let count = 0;
    const interval = setInterval(() => {
      parent.style.boxShadow =
        count % 2 === 0 ? "0 0 15px 5px red" : "none";
      count++;
      if (count > 5) { // é—ªçƒ 3 æ¬¡
        clearInterval(interval);
        parent.style.boxShadow = "none";
      }
    }, 400);
  }
}

function find_paiwei(item) {
  if (!item || !item.item_location || !item.item_location[0]) {
    console.warn("âŒ æ— æ•ˆçš„ item:", item);
    return;
  }

  const pdfId = item.item_location[0].pdf_page_data.print_pdf_id;
  const el = document.querySelector(`[data-print-pdf-id="${pdfId}"]`);

  if (el) {
    console.log(`âœ… æ‰¾åˆ° print_pdf_id=${pdfId} çš„ DOM`);
    highlight_pdf(el.dataset.sideId);
  } else {
    Pushpopup(`âŒ æ²¡æ‰¾åˆ° print_pdf_id=${pdfId} çš„ DOM`);
  }
}


// âœ… ä¿®æ”¹æ‹–åŠ¨å‡½æ•°ï¼Œå…è®¸ä¼  modal + head
function makeModalDraggable(modal, head) {
  let offsetX = 0, offsetY = 0, isDown = false;

  head.addEventListener("mousedown", e => {
    isDown = true;
    offsetX = e.clientX - modal.offsetLeft;
    offsetY = e.clientY - modal.offsetTop;
    head.style.cursor = "grabbing";
  });

  document.addEventListener("mousemove", e => {
    if (!isDown) return;
    modal.style.left = (e.clientX - offsetX) + "px";
    modal.style.top = (e.clientY - offsetY) + "px";
  });

  document.addEventListener("mouseup", () => {
    isDown = false;
    head.style.cursor = "move";
  });
}


function openPdfModal(board_id, board_name) {
    currentBoardId = board_id;
    currentBoardName = board_name;

    const modal = document.getElementById("pdfModal");
    const input = document.getElementById("pdfInput");
    modal.style.display = "flex";
    input.value = "";
    input.focus();
}

// å…³é—­ modal
document.getElementById("pdfCloseBtn").addEventListener("click", () => {
  document.getElementById("pdfModal").style.display = "none";
});

// ä¿å­˜é€»è¾‘ï¼ˆå¸¦é€‰é¡¹ï¼šæ˜¯å¦å…³é—­ modalï¼‰
async function savePdf(closeAfterSave = true) {
  const input = document.getElementById("pdfInput");
  const pdf_id = input.value.trim();
  if (!pdf_id) {
    alert("è¯·è¾“å…¥ PDF ID");
    return;
  }

  const result = await add_pdf(currentBoardId, pdf_id, currentBoardName);

  if (result && result.success) {
    if (closeAfterSave) {
      // æ­£å¸¸æŒ‰é’®ä¿å­˜ â†’ å…³é—­ modal
      document.getElementById("pdfModal").style.display = "none";
    } else {
      // å›è½¦ä¿å­˜ â†’ æ¸…ç©ºå¹¶é‡æ–°èšç„¦
      input.value = "";
      input.focus();
      generate_fahui_board();
    }
  } else {
    alert(result.message || "ä¿å­˜å¤±è´¥");
  }
}

// ä¿å­˜æŒ‰é’®é€»è¾‘ï¼ˆç‚¹æŒ‰é’® â†’ ä¿å­˜å¹¶å…³é—­ï¼‰
document.getElementById("pdfSaveBtn").addEventListener("click", () => {
  savePdf(true);
});

// ç›‘å¬å›è½¦è¾“å…¥ PDF IDï¼ˆå›è½¦ â†’ ä¿å­˜ï¼Œä¸å…³é—­ï¼‰
document.getElementById("pdfInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault(); // é˜²æ­¢ form æäº¤
    savePdf(false);
  }
});



async function add_board() {
    const board_name = prompt("è¯·è¾“å…¥ board_name:");
    if (!board_name || board_name.trim() === "") {
        alert("board_name ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }

    // âš¡ è®¡ç®—æ–°çš„ board_id
    let newBoardId = 1;
    if (group_data.length > 0) {
        const maxId = Math.max(...group_data.map(b => b.board_id));
        newBoardId = maxId + 1;
    }

    const result = await add_pdf(newBoardId, "none", board_name.trim());

    // âš¡ å¼¹å‡ºçŠ¶æ€æç¤º
    if (result.success) {
        Pushpopup(result.message || "æ–°å¢ PDF æˆåŠŸï¼");
        generate_fahui_board();
    } else {
        Pushpopup(result.message || "æ–°å¢ PDF å¤±è´¥ï¼");
    }
}

async function add_pdf(board_id, pdf_id="none", board_name="none") {
    try {
        const response = await fetch("/api/add_pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ board_id, pdf_id, board_name })
        });

        if (!response.ok) {
            return { success: false, message: "æœåŠ¡å™¨å“åº”å¤±è´¥" };
        }
        const res = await response.json();

        // âš¡ è¦†ç›– group_dataï¼Œä¿æŒå’Œæ•°æ®åº“åŒæ­¥
        group_data = res.all_board;

        console.log(`åœ¨ board_id=${board_id} æ–°å¢ PDF:`, res);

        return { success: true, message: res.message || "æ–°å¢æˆåŠŸ" };
    } catch (err) {
        console.error("add_pdf å‡ºé”™:", err);
        return { success: false, message: err.message || "æœªçŸ¥é”™è¯¯" };
    }
}

let cache = false; // æˆ– false
function generate_fahui_board() {
    const container = document.getElementById("group_container");
    if (!container) {
        console.warn("æœªæ‰¾åˆ°å®¹å™¨ #group_container");
        return;
    }

    const existingBoards = new Map(
        Array.from(container.children).map(div => [div.id, div])
    );

    const seenBoardIds = new Set();

    group_data.forEach(data => {
        const boardId = `board_id_${data.board_id}`;
        seenBoardIds.add(boardId);

        let boardDiv = existingBoards.get(boardId);
        if (!boardDiv) {
            boardDiv = document.createElement("div");
            boardDiv.className = "white_board";
            boardDiv.id = boardId;
            container.appendChild(boardDiv);
        } else {
            boardDiv.innerHTML = "";
        }

        const title = document.createElement("h4");
        title.className = "board_title";
        title.textContent = data.board_name;

        const addIcon = document.createElement("span");
        addIcon.className = "add_pdf_icon";
        addIcon.innerHTML = '<i class="fas fa-plus-circle"></i>';
        addIcon.style.cursor = "pointer";
        addIcon.style.marginLeft = "8px";

        addIcon.addEventListener("click", () => {
            openPdfModal(data.board_id, data.board_name);
        });

        const editIcon = document.createElement("span");
        editIcon.className = "edit_board_data_icon";
        editIcon.innerHTML = '<i class="fas fa-edit"></i>';
        editIcon.style.cursor = "pointer";
        editIcon.style.marginLeft = "8px";

        editIcon.addEventListener("click", () => {
            editBoardData(data);
        });

        title.appendChild(addIcon);
        title.appendChild(editIcon);
        boardDiv.appendChild(title);

        // âœ… ç”Ÿæˆ pdf åŒºåŸŸ
        const pdfArea = createPdfPapers(data.board_data, data.board_width);
        pdfArea.id = `pdf_area_${data.board_id}`;   // ç»™æ¯ä¸ª pdf åŒºåŸŸå”¯ä¸€ id
        boardDiv.appendChild(pdfArea);

        // âœ… åœ¨è¿™é‡Œç»‘å®šæ‹–åŠ¨
        // enableDragSort(pdfArea, data.board_id);
    });

    existingBoards.forEach((div, id) => {
        if (!seenBoardIds.has(id)) {
            div.remove();
        }
    });
}


function createPdfPapers(board_data, board_width) {
    const pdfArea = document.createElement("div");
    pdfArea.className = "pdf_area";

    if (board_width) {
        pdfArea.style.display = "grid";
        pdfArea.style.gridTemplateColumns = `repeat(${board_width}, max-content)`;
        pdfArea.style.gap = "8px";
        pdfArea.style.overflowX = "auto";
        pdfArea.style.overflowY = "hidden";
    }

    if (Array.isArray(board_data) && board_data.length > 0) {
        board_data.sort((a, b) => (a.location || 9999) - (b.location || 9999));

        board_data.forEach(item => {
            const pdfDiv = document.createElement("div");
            pdfDiv.id = `pdf_id_${item.side_id}`;
            pdfDiv.className = "pdf_paper";
            pdfDiv.dataset.sideId = item.side_id;
            pdfDiv.dataset.printPdfId = item.print_pdf_id;

            if (item.width && item.height) {
                const maxWidth = 150;
                const maxHeight = 300;

                // æŒ‰æ¯”ä¾‹ç¼©æ”¾
                const scale = Math.min(maxWidth / item.width, maxHeight / item.height);

                pdfDiv.style.width = (item.width * scale) + "px";
                pdfDiv.style.height = (item.height * scale) + "px";
                pdfDiv.style.position = "relative";
            }

            // âœ… é¡¶éƒ¨çš„å°å®¹å™¨
            const label = document.createElement("div");
            label.className = "order-id-label";
            label.textContent = item.orders && item.orders.length > 0
                ? `#${item.print_pdf_id}`   // æ˜¾ç¤ºç¬¬ä¸€ä¸ª order çš„ id
                : "-";
            pdfDiv.appendChild(label);

            // å›¾ç‰‡
            const img = document.createElement("img");
            img.src = cache
                ? `/print_paiwei/print_paiwei_order_item/${item.print_pdf_id}?cache=${Date.now()}`
                : `/print_paiwei/print_paiwei_order_item/${item.print_pdf_id}`;
            img.style.width = "100%";
            img.style.height = "100%";
            pdfDiv.appendChild(img);

            // ç‚¹å‡» & å³é”®äº‹ä»¶
            pdfDiv.addEventListener("click", (e) => {
                open_selection(e, item);
            });

            pdfDiv.addEventListener("contextmenu", (e) => {
                open_selection(e, item);
            });

            pdfArea.appendChild(pdfDiv);
        });

    } else {
        const emptyMsg = document.createElement("p");
        emptyMsg.className = "empty_notice";
        emptyMsg.textContent = "æš‚æ—  PDF";
        pdfArea.appendChild(emptyMsg);
    }

    return pdfArea;
}

function enableDragSort(container, board_id) {
  Sortable.create(container, {
    animation: 150,                 // å¹³æ»‘åŠ¨ç”»
    ghostClass: "drag-ghost",       // å ä½å…ƒç´ çš„æ ·å¼
    chosenClass: "drag-chosen",     // è¢«æ‹–åŠ¨å…ƒç´ çš„æ ·å¼
    dragClass: "dragging",          // æ‹–åŠ¨æ—¶ç»™ body çš„ class
    // forceFallback: true,          // âœ… å¼ºåˆ¶ä½¿ç”¨å…‹éš†å…ƒç´ æ¥æ˜¾ç¤ºæ‹–åŠ¨æ•ˆæœ
    // fallbackClass: "drag-fallback", // æ‹–åŠ¨æ—¶çš„çœŸå®å ä½å…ƒç´ 
    // fallbackTolerance: 3,

    onEnd: async function (evt) {
      const draggedEl = evt.item;
      const printPdfId = draggedEl.dataset.printPdfId;
      const newIndex = evt.newIndex + 1; // ä» 1 å¼€å§‹çš„ location

      console.log(`ğŸ“Œ æ‹–åŠ¨ PDF ${printPdfId} åˆ° board=${board_id}, ä½ç½®=${newIndex}`);

      try {
        const res = await fetch("/api/insert_pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            board_id: board_id,
            pdf_id: parseInt(printPdfId),
            location: newIndex
          })
        });
        const data = await res.json();
        console.log("âœ… æ’å…¥ç»“æœ:", data);
      } catch (err) {
        console.error("âŒ æ’å…¥å¤±è´¥:", err);
      }
    }
  });
}


// å¼¹å‡ºå¤§å›¾ Modal
function showImageModal(printPdfId) {
    // å¦‚æœå·²å­˜åœ¨å°±å…³é—­ï¼ˆå¼€å…³æ•ˆæœï¼‰
    let exist = document.querySelector(".image_modal");
    if (exist) {
        exist.remove();
        return;
    }

    // åˆ›å»ºå®¹å™¨
    const modal = document.createElement("div");
    modal.className = "image_modal";

    // å¤§å›¾
    const img = document.createElement("img");
    img.src = `/print_paiwei/print_paiwei_order_item/${printPdfId}?t=${Date.now()}`;
    img.className = "image_modal_img";

    // ç›´æ¥ç‚¹èƒŒæ™¯æˆ–å›¾ç‰‡å…³é—­
    modal.onclick = () => modal.remove();
    img.onclick = () => modal.remove();

    modal.appendChild(img);
    document.body.appendChild(modal);
}

function open_selection(e, item) {
  e.preventDefault();   // é˜»æ­¢é»˜è®¤å³é”®èœå•
  e.stopPropagation();  // é˜²æ­¢å†’æ³¡å¯¼è‡´ç«‹åˆ»å…³é—­

  // ç§»é™¤æ—§èœå•
  const oldMenu = document.getElementById("contextMenu");
  if (oldMenu) oldMenu.remove();

  const menu = document.createElement("div");
  menu.id = "contextMenu";
  menu.className = "context-menu";
  menu.style.top = e.pageY + "px";
  menu.style.left = e.pageX + "px";


  const actions = [
    { name: "delete_pdf", label: "åˆ é™¤ PDF", handler: () => delete_pdf(item) },
    { name: "edit_pdf", label: "ç¼–è¾‘ PDF", handler: () => edit_pdf(item) },
    { name: "download_pdf", label: "ä¸‹è½½ PDF", handler: () => download_pdf(item) },
    { 
      name: "remove_highlight", 
      label: "å…³é—­é«˜äº®", 
      handler: () => {
        console.log("remove id:"+ item.side_id)
        const el = document.getElementById(`pdf_id_${item.side_id}`);
        el.classList.remove("highlight");
      }
    },
    { name: "download_pdf", label: "æŸ¥çœ‹", handler: () => showImageModal(item.print_pdf_id) },
  ];

  actions.forEach(action => {
    const option = document.createElement("div");
    option.className = `context-menu-item ${action.name}`;
    option.textContent = action.label;
    option.addEventListener("click", () => {
      action.handler();
      menu.remove();
    });
    menu.appendChild(option);
  });


  document.body.appendChild(menu);

  document.addEventListener("click", () => {
    if (menu) menu.remove();
  }, { once: true });
}

async function delete_pdf(item) {
  console.log("delete_pdf called:", item);

  const board_data_id = item.side_id;
  if (!board_data_id) {
    alert("æ— æ•ˆçš„ board_data_id");
    return;
  }

  // âš¡ ç¡®è®¤å¼¹çª—
  if (!confirm(`ç¡®å®šè¦åˆ é™¤ PDF (side_id=${board_data_id}) å—ï¼Ÿ`)) {
    return; // ç”¨æˆ·å–æ¶ˆ
  }

  try {
    const response = await fetch(`/api/delete_board/${board_data_id}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json"
      }
    });

    const result = await response.json();

    if (result.status === "success") {
      Pushpopup(result.message || "åˆ é™¤æˆåŠŸ");
      // âš¡ æ›´æ–°å‰ç«¯ç¼“å­˜
      if (result.all_board) {
        group_data = result.all_board;
        generate_fahui_board();
      }
    } else {
      Pushpopup(result.message || "åˆ é™¤å¤±è´¥");
    }
  } catch (err) {
    console.error("delete_pdf å‡ºé”™:", err);
    Pushpopup("è¯·æ±‚å¼‚å¸¸");
  }
}


function edit_pdf(item) {
  console.log("edit_pdf called:", item);
}

function download_pdf(item) {
  console.log("download_pdf called:", item);
}


function view_order_detail(print_pdf_id) {
    // æ‰“å¼€è®¢å•è¯¦æƒ…é¡µé¢
    window.open(`/order_detail/${print_pdf_id}`, "_blank");
}
function editBoardData(data) {
    // å¦‚æœå·²å­˜åœ¨ modal å…ˆç§»é™¤
    let oldModal = document.getElementById("edit_board_data_modal");
    if (oldModal) oldModal.remove();

    // åˆ›å»º modal å®¹å™¨
    const modal = document.createElement("div");
    modal.id = "edit_board_data_modal";
    modal.style.position = "fixed";
    modal.style.top = "50%";
    modal.style.left = "50%";
    modal.style.transform = "translate(-50%, -50%)";
    modal.style.background = "var(--bg-color)";
    modal.style.color = "var(--text-color)";
    modal.style.padding = "20px";
    modal.style.boxShadow = "0 2px 10px rgba(0,0,0,0.3)";
    modal.style.border = "1px solid var(--border-color)";
    modal.style.zIndex = "1000";
    modal.style.minWidth = "320px";
    modal.style.borderRadius = "6px";

    // å¡«å……è¡¨å•
    modal.innerHTML = `
        <h3 style="color: var(--title-color); margin-top: 0;">Edit Board Data</h3>
        <label>Board Name:</label>
        <input type="text" id="edit_board_name" class="Input" value="${data.board_name || ""}" style="width:100%;margin-bottom:10px;" />

        <label>Board Width:</label>
        <input type="number" id="edit_board_width" class="Input" value="${data.board_width || ""}" style="width:100%;margin-bottom:10px;" />

        <label>Board Height:</label>
        <input type="number" id="edit_board_height" class="Input" value="${data.board_height || ""}" style="width:100%;margin-bottom:10px;" />

        <div style="text-align:right;">
            <button id="edit_board_save" 
                style="background: var(--save-button-bg); color: var(--button-text-color); border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">
                Save
            </button>
            <button id="edit_board_cancel" 
                style="background: var(--delete-button-bg); color: var(--button-text-color); border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-left:6px;">
                Cancel
            </button>
        </div>
    `;

    document.body.appendChild(modal);

    // ç»‘å®šæŒ‰é’®
    document.getElementById("edit_board_save").addEventListener("click", () => {
        const updatedData = {
            board_id: data.board_id,
            board_name: document.getElementById("edit_board_name").value,
            board_width: document.getElementById("edit_board_width").value,
            board_height: document.getElementById("edit_board_height").value,
            pdf_id: null   // âš¡ å› ä¸ºåªæ˜¯ç¼–è¾‘ board ä¿¡æ¯ï¼Œè¿™é‡Œå¯ä»¥ä¼  null
        };

        // è°ƒç”¨åç«¯ API
        fetch("/api/add_pdf", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updatedData)
        })
        .then(res => res.json())
        .then(resp => {
            console.log("ä¿å­˜æˆåŠŸ:", resp);
            modal.remove();
            window.location.reload(); // åˆ·æ–°å½“å‰é¡µé¢
        })
        .catch(err => {
            console.error("ä¿å­˜å¤±è´¥:", err);
        });
    });

    document.getElementById("edit_board_cancel").addEventListener("click", () => {
        modal.remove();
    });
}

</script>
{% endblock %}
