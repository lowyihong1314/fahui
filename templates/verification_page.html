{% extends "base.html" %}

{% block title %}æ‰‹æœºè®¤è¯{% endblock %}

{% block content %}
<style>
/* éªŒè¯å®¹å™¨æ ·å¼ */
#verify_container {
  max-width: 360px;
  margin: 60px auto;
  padding: 25px 30px;
  background: var(--bg-color);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
  text-align: center;
  animation: fadeInUp 0.6s ease;
}

/* æ ‡é¢˜ */
#verify_container h2 {
  font-size: 1.5em;
  font-weight: bold;
  margin-bottom: 15px;
  background: linear-gradient(90deg, var(--title-color), var(--title-color-right));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* æç¤ºæ–‡å­— */
#verify_container p {
  color: var(--text-color);
  margin-bottom: 15px;
}

/* è¾“å…¥æ¡† */
#verify_container input[type="text"] {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 1em;
  outline: none;
  transition: all 0.3s ease;
}
#verify_container input[type="text"]:focus {
  border-color: var(--title-color);
  box-shadow: 0 0 6px rgba(0, 124, 240, 0.2);
}

/* æŒ‰é’®é€šç”¨ */
#verify_container button {
  width: 100%;
  padding: 10px 14px;
  margin-top: 12px;
  font-size: 1em;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  color: var(--button-text-color);
  transition: all 0.3s ease;
  transform: translateY(0);
}

/* å‘é€æŒ‰é’® */
#sendCodeBtn {
  background: var(--edit-button-bg);
}
#sendCodeBtn:hover {
  background: var(--edit-button-bg-hover);
  transform: translateY(-2px);
}

/* éªŒè¯æŒ‰é’® */
#verifyBtn {
  background: var(--save-button-bg);
}
#verifyBtn:hover {
  background: var(--save-button-bg-hover);
  transform: translateY(-2px);
}

/* é”™è¯¯æˆ–æç¤ºæ¶ˆæ¯ */
#message {
  margin-top: 10px;
  font-size: 0.9em;
  color: var(--ping-color);
  min-height: 20px;
  transition: opacity 0.3s ease;
}

/* å®¹å™¨æ·¡å…¥åŠ¨ç”» */
@keyframes fadeInUp {
  0% {
    opacity: 0;
    transform: translateY(15px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

</style>

<div id="verify_container">
  <h2>æ‰‹æœºè®¤è¯</h2>
  <p>è¯·éªŒè¯æ‰‹æœºå·ï¼š<strong>{{ phone_number }}</strong></p>
  <strong>å¦‚æœæ— æ³•è·³è½¬ç›´æ¥æ‹¨æ‰“:</strong>
  <phone onclick="submit_secret_code()">+601136600057</phone>

  <div id="message"></div>

  <button id="sendCodeBtn">å‘é€éªŒè¯ç </button>

  <div id="verifySection" style="display:none; margin-top:20px;">
    <input type="text" id="otpInput" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6" />
    <button id="verifyBtn">éªŒè¯</button>
  </div>
  <small id="your_ip"></small>
</div>

<script>
const phone_number = "{{ phone_number }}";
const order_id = "{{ order_id }}";

async function submit_secret_code() {
  const secret_code = prompt("è¯·è¾“å…¥å¯†é’¥:");

  if (!secret_code) {
    alert("å¯†é’¥ä¸èƒ½ä¸ºç©º");
    return;
  }

  try {
    const response = await fetch("/twilio_service/submit_secret_code", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        order_id: order_id,
        secret_code: secret_code
      })
    });

    const data = await response.json();
    const messageDiv = document.getElementById("message");

    if (data.status === "success") {
      messageDiv.style.color = "green";
      messageDiv.textContent = "éªŒè¯æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...";
      window.location.href = `/template/fahui_input/${order_id}`;
    } else {
      messageDiv.style.color = "red";
      messageDiv.textContent = data.message || "éªŒè¯å¤±è´¥";
    }
  } catch (err) {
    console.error("è¯·æ±‚å‡ºé”™:", err);
    alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•");
  }
}
const sendCodeBtn = document.getElementById('sendCodeBtn');
const verifySection = document.getElementById('verifySection');
const verifyBtn = document.getElementById('verifyBtn');
const otpInput = document.getElementById('otpInput');
const messageDiv = document.getElementById('message');

sendCodeBtn.addEventListener('click', async () => {
  messageDiv.textContent = '';
  sendCodeBtn.disabled = true;
  sendCodeBtn.textContent = 'å‘é€ä¸­...';

  try {
    const res = await fetch('/twilio_service/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order_id })  // åªä¼  order_id
    });

    const data = await res.json();
    if (data.status === 'success') {
      messageDiv.style.color = 'green';
      messageDiv.textContent = data.message;
      verifySection.style.display = 'block';
      sendCodeBtn.style.display = 'none';
    } else {
      messageDiv.style.color = 'red';
      messageDiv.textContent = data.message || 'å‘é€å¤±è´¥';
      sendCodeBtn.disabled = false;
      sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
    }
  } catch (err) {
    messageDiv.style.color = 'red';
    messageDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
    sendCodeBtn.disabled = false;
    sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
  }
});

verifyBtn.addEventListener('click', async () => {
  messageDiv.textContent = '';
  const otp = otpInput.value.trim();

  if (!otp || otp.length !== 6) {
    messageDiv.style.color = 'red';
    messageDiv.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½éªŒè¯ç ';
    return;
  }

  verifyBtn.disabled = true;
  verifyBtn.textContent = 'éªŒè¯ä¸­...';

  try {
    const res = await fetch('/twilio_service/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ otp })
    });

    const data = await res.json();

    if (data.status === 'success') {
      messageDiv.style.color = 'green';
      messageDiv.textContent = 'éªŒè¯æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...';
      window.location.href = `/template/fahui_input/${order_id}`;

    } else {
      messageDiv.style.color = 'red';
      messageDiv.textContent = data.message || 'éªŒè¯ç é”™è¯¯';
      verifyBtn.disabled = false;
      verifyBtn.textContent = 'éªŒè¯';
    }

  } catch (err) {
    messageDiv.style.color = 'red';
    messageDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
    verifyBtn.disabled = false;
    verifyBtn.textContent = 'éªŒè¯';
  }
});

async function showIpFlag(ip) {
  try {
    // è°ƒç”¨ ipwhois è·å–å›½å®¶ä¿¡æ¯
    const res = await fetch(`https://ipwho.is/${ip}`);
    const data = await res.json();

    if (data.success && data.country_code) {
      // æŠŠå›½å®¶ä»£ç è½¬æˆå›½æ—— emoji
      const flag = countryCodeToFlagEmoji(data.country_code);
      document.getElementById("your_ip").textContent = `${ip} ${flag}|${order_id}`;
    } else {
      document.getElementById("your_ip").textContent = `${ip} ğŸŒ|${order_id}`;
    }
  } catch (e) {
    document.getElementById("your_ip").textContent = `${ip} ğŸŒ|${order_id}`;
  }
}

// è¾…åŠ©å‡½æ•°ï¼šå›½å®¶ä»£ç  â†’ emoji å›½æ——
function countryCodeToFlagEmoji(countryCode) {
  return countryCode
    .toUpperCase()
    .replace(/./g, char => 
      String.fromCodePoint(127397 + char.charCodeAt())
    );
}

// é¡µé¢åŠ è½½åæ‰§è¡Œ
document.addEventListener("DOMContentLoaded", () => {
  const ip = "{{ip}}"; // æ¨¡æ¿æ¸²æŸ“è¿›æ¥çš„å€¼
  showIpFlag(ip);
});

</script>

{% endblock %}
